## Введение

Gmonit предлагает инструмент для сбора, агрегации и визуализации метрик ИТ-инфраструктуры. Установленный агент собирает и передаёт метрики, работая как в облаке, так и на выделенных серверах или в контейнерах под управлением оркестраторов. Это помогает быстро оценить использование ресурсов и выявить узкие места и корневые причины инцидентов.

GMonit поддерживает из коробки мониторинг БД Oracle, MS SQL, MySQL и PostgreSQL, Nginx, Redis, Elasticsearch, а так же SAP и 1С.

## Что собираем?

- Ключевые метрики утилизации ресурсов хоста (CPU, диск, память, сеть)
- Метрики Docker-контейнеров на хосте
- Таблица процессов
- Метрики баз данных

## Мониторинг хоста и Docker-контейнеров
 
Для перехода к дашбордам инфраструктурного мониторинга используем выпадающий список Infrastructure (в правом верхнем углу).

![list](images/infra_list.png)

На дашбордe **Containers** по каждому контейнеру можно посмотреть показатели использования ядер процессора (CPU usage Cores), загрузку процессора (CPU usage), использование памяти (Mem usage) и хранилища (Storage usage), количество перезапусков контейнера и статистику по сетевому трафику (Network traffic).

![container](images/infra_containers.png)

Дашборд **Hosts** содержит сводные графики здоровья хоста: CPU usage, Mem usage, Storage usage, Network traffic. Load average - средние значения загрузки системы за определённый период времени (1, 5, 15 мин) и процессы запущенные в системе - Processes.

![hosts](images/infra_hosts.png)

![hosts](images/infra_hosts2.png)

## Мониторинг NGINX:

При переходе через меню мониторинга мы попадаем на дашборд с веб-серверами, на которые установлен агент. 

![nginx](images/infra_nginx.png)

Графики выводят следующие количественные метрики по запросам и соединениям:
**Requests per minute** - показывает количество HTTP-запросов, обработанных сервером за минуту. 

**Active Connections** - число текущих активных соединений с веб-сервером. Дает представление о текущей нагрузке на сервер.

**Connections Accepted per minute** - количество соединений, которые были приняты сервером за минуту.

**Connections Dropped per minute** - количество соединений, которые были отклонены или сброшены сервером за минуту.

**Connections Reading** - количество соединений, в которых Nginx читает данные, полученные от клиентов. Рост этой метрики может сигнализировать о высоких объемах входящего трафика, что может повлиять на скорость обработки.

**Connections Waiting** - количество соединений, находящихся в состоянии ожидания (idle), когда все данные были прочитаны, но новые данные пока не поступили. Высокое значение может указывать на задержки и проблемы с соединениями.

**Connections Writing**  - количество соединений, в которых Nginx отправляет данные клиентам. Это показывает активность ответа сервера на запросы пользователей. 

## Мониторинг СУБД

Для мониторинга баз данных MS SQL, PostgreSQL, MySQL и Oracle можно выделить несколько общих метрик, которые важны для оценки производительности, состояния и надежности работы базы данных. Эти метрики схожи для всех четырех СУБД, хотя могут немного различаться в деталях реализации.
1. **Количество активных соединений (Active Connections)** Показывает количество активных пользователей и приложений, которые в данный момент подключены к базе данных. Это важно для оценки нагрузки на сервер БД и предотвращения перегрузки соединений.
2. **Использование процессора (CPU Usage)** Процент использования CPU сервером базы данных.
3. **Использование памяти (Memory Usage)** Показывает, сколько оперативной памяти использует база данных для кэширования данных и выполнения запросов. Недостаток памяти может приводить к частым обращениям на диск, что снижает производительность.
4. **Производительность диска (Disk I/O)** Время и количество операций ввода-вывода на диск. Высокая нагрузка на диск может замедлять выполнение запросов, особенно если используются медленные устройства хранения.
5. **Количество блокировок (Locks/Deadlocks)** Количество блокировок на уровне таблиц или строк, а также количество взаимных блокировок (deadlock). Эти метрики помогают отслеживать проблемы с конкурентным доступом к данным.
6. **Время выполнения запросов (Query Latency)** Время, необходимое для выполнения запросов.
7. **Пропускная способность (Throughput)** Количество транзакций, запросов или операций ввода-вывода, которые база данных обрабатывает за единицу времени.
8. **Использование кэша (Cache Hit Ratio)** Доля запросов, которые были удовлетворены из кэша, без необходимости чтения данных с диска. Высокий показатель кэша означает, что данные эффективно кэшируются, что ускоряет обработку запросов.
9. **Время ожидания (Wait Time/Wait Events)** Время, которое запросы проводят в ожидании выполнения из-за блокировок, ввода-вывода или других факторов.
10. **Ошибки и сбои (Errors)** Любые ошибки или сбои, возникающие при выполнении запросов или транзакций.

На дашбордах Summary и Extended выведены эти основные метрики, а так же специфичные для перечисленных СУБД. Они позволяют отслеживать общую производительность, диагностику узких мест и выявление потенциальных проблем с ресурсами.

### Мониторинг PostgreSQL

![psql](images/infra_psql.png)

![psql2](images/infra_psql2.png)

Ключевые метрики производительности:

**Checkpoint write time** ms/sec - это время в миллисекундах, которое требуется для записи контрольной точки. Контрольная точка - это процесс, который PostgreSQL использует для сохранения состояния базы данных на диск. Долгое время записи может указывать на проблемы с производительностью диска или большую нагрузку на запись данных. В идеале, время должно быть минимальным, чтобы избежать блокировок и задержек.

**Checkpoint sync time** - это время, затраченное на выполнение операции синхронизации при создании контрольной точки. Операция синхронизации гарантирует, что все изменения, сделанные в памяти, будут записаны на диск. Высокое значение может указывать на проблемы с дисковой подсистемой или медленные операции ввода-вывода. Долгое время синхронизации может привести к задержкам в обслуживании запросов.

**Index sizes** - это размеры индексов на ваших таблицах в базе данных PostgreSQL. Индексы используются для ускорения поиска данных в таблицах. Крупные индексы могут замедлять вставку, обновление и удаление данных. Растущие индексы также могут указывать на фрагментацию данных, что снижает производительность запросов.

**Buffer allocated per second** - это количество буферов, выделяемых в секунду. Буферы используются для временного хранения данных перед их записью на диск или отображением на экране. Высокие значения могут указывать на активную работу с буферами, что требует мониторинга нагрузки на память.

**Backend FSync calls per second** - это количество вызовов FSync для бэкендов в секунду. Операция FSync гарантирует, что все изменения, сделанные в памяти, будут записаны на диск. Высокое количество вызовов может указывать на большую нагрузку на дисковую систему или частые записи данных на диск.

**Buffers written per backend** - это количество буферов, записываемых каждым бэкендом. Бэкенды - это процессы, которые обрабатывают запросы к базе данных. Высокое количество записанных буферов может сигнализировать о высоком уровне изменений в базе данных.

**Table raws inserted per second** - это количество строк, вставленных в таблицу в секунду. Высокая скорость вставки данных указывает на активную запись в базу данных. Если скорость вставки падает, это может сигнализировать о проблемах с производительностью или блокировках.

**Table sizes in bytes** - это размеры таблиц в байтах. Растущие размеры таблиц могут привести к ухудшению производительности запросов.

**Table bloat size and percent bloat** - это размер и процент раздувания таблицы. Раздувание таблицы происходит, когда в ней хранится больше данных, чем необходимо для ее эффективной работы. Большой процент «раздувания» таблицы может привести к замедлению запросов и увеличению расхода дискового пространства.

**Database connections count** - это количество активных соединений к базе данных. Может указывать на высокую нагрузку на сервер, что требует настройки пула подключений и контроля за ресурсами.

**Buffer hits per second** - это количество попаданий в буфер в секунду. Попадание в буфер означает, что данные уже были загружены в память и не требуют повторной загрузки.

**Deadlocks per second** - это количество взаимных блокировок в секунду. Взаимоблокировка происходит, когда два или более процессов пытаются получить доступ к одному и тому же ресурсу одновременно. Наличие взаимных блокировок указывает на проблемы с конкурентным доступом к данным. Множество блокировок может вызвать простои и задержки в выполнении запросов.

### Мониторинг Redis 

Cобирает следующие метрики, которые помогают лучше понимать текущее состояние инстансов Redis и своевременно реагировать на потенциальные проблемы с производительностью или ресурсами:

![redis](images/infra_redis.png)

![redis2](images/infra_redis2.png)

**Commands per second** - количество команд, обработанных в секунду. Высокое значение указывает на интенсивную активность, в то время как резкое падение может свидетельствовать о проблемах с задержкой или блокировками.

**Connected clients** - количество клиентов, которые в данный момент подключены к серверу Redis. Каждый клиент представляет собой активное подключение к базе данных. Высокое число подключений может указывать на пиковую нагрузку, что требует управления ресурсами. Наблюдение за количеством подключенных клиентов помогает предсказать возможные проблемы с масштабируемостью.

**Blocked clients** - количество клиентов, которые заблокированы в ожидании завершения длинных операций, таких как команды BLPOP или BRPOP, блокирующие операции с очередями. Большое количество заблокированных клиентов может означать проблемы с производительностью, так как операции, на которые они ожидают, могут быть медленными или заблокированными.

**Redis used memory** (bytes) - память используемая Redis. Метрика включает в себя память, занятую всеми данными, кэшем, и дополнительной информацией для управления объектами. Исчерпывание памяти может привести к сбросу ключей или сбоям.

**Changes since last save** - количество изменений данных (записей) с момента последнего сохранения на диск. Если количество изменений с последнего сохранения велико, то в случае сбоя данные могут быть потеряны. Своевременное сохранение данных на диск критически важно для минимизации потерь.

**Keyspace hit ratio** - Это отношение количества успешных запросов к ключам к общему количеству запросов. Рассчитывается как: (keyspace_hits / (keyspace_hits + keyspace_misses)). Высокое значение этой метрики говорит о том, что большинство запросов находят нужные данные в кэше, что повышает производительность системы. Низкое значение указывает на то, что сервер часто не находит запрашиваемые ключи.

**Evicted keys per second** - показатель количества ключей, которые Redis удалил из памяти из-за нехватки ресурсов (когда достигнут лимит по памяти). Эти ключи вытесняются согласно выбранной политике управления памятью. Если ключи часто вытесняются, это может указывать на проблемы с памятью или на необходимость увеличения объема памяти.

**Network I/O per second** (bytes) - метрика показывает количество данных, отправляемых и получаемых через сеть каждую секунду. Она отражает объем трафика между сервером Redis и его клиентами. Высокое сетевое потребление может повлиять на общую производительность.

### Мониторинг Elasticsearch

На дашбордах Elasticsearch отображается информация об имеющихся нодах и кластерах, поставленных на мониторинг. GMonit строит графики состояния по индексам и производительности (Indices и Perfomance), а так же JVM, heap memory, индексации и операциям слияния (merge). Они помогают отслеживать состояние системы и ее производительность.
На дашборде **Indices** располагаются графики:

Indexing Operations Failed: Количество неудачных операций индексирования. Неудачные операции индексирования могут быть вызваны различными причинами, такими как отсутствие прав доступа, ошибки в документе или внутренние ошибки Elasticsearch. Этот показатель помогает выявить проблемы с индексированием и принять меры для их устранения.

Number Indices: Количество индексов в кластере. Этот показатель отражает общее число индексов, созданных в кластере Elasticsearch. Он может быть полезен для понимания структуры данных и оценки нагрузки на кластер.

Memory Query Cache: Память, использованная кэшем запросов. Кэш запросов используется для хранения результатов часто выполняемых запросов, что позволяет сократить время их выполнения в будущем. Этот показатель помогает оценить эффективность кэширования и необходимость его оптимизации.

Indexing Waited Throttling: Время, проведенное в ожидании ограничения индексирования. Этот показатель указывает на время, в течение которого индексирующие процессы находились в режиме ожидания из-за ограничений, наложенных на индексирование. Это может быть связано с настройками кластера или чрезмерной нагрузкой на индексирование.

Query cache: Кэш запросов. Используется для хранения результатов часто выполняемых запросов, что позволяет сократить время их выполнения в будущем. Этот показатель помогает оценить эффективность кэширования и необходимость его оптимизации.

Recovery Ongoing Shard Source: Текущий статус восстановления разделов источника. Этот показатель отражает текущий статус восстановления разделов источника данных. Он может быть полезен для понимания состояния кластера и необходимости вмешательства для обеспечения бесперебойной работы.

Recovery Ongoing Shard Target: Текущий статус восстановления разделов целевого. Этот показатель отражает текущий статус восстановления разделов целевого узла кластера. Он может быть полезен для понимания состояния кластера и необходимости вмешательства для обеспечения бесперебойной работы.

Recovery Waited Throttling: Время, проведенное в ожидании ограничения восстановления. Этот показатель указывает на время, в течение которого процессы восстановления находились в режиме ожидания из-за ограничений, наложенных на восстановление. Это может быть связано с настройками кластера или чрезмерной нагрузкой на восстановление.

Segments Index Shard: Разделы индекса разделов. Этот показатель отражает количество и размер разделов индекса разделов в кластере. Он может быть полезен для понимания структуры данных и оценки нагрузки на кластер.

Request cache: Кэш запросов. Кэш запросов используется для хранения результатов часто выполняемых запросов, что позволяет сократить время их выполнения в будущем. Этот показатель помогает оценить эффективность кэширования и необходимость его оптимизации.

Memory Used метрики: Использование памяти. Этот показатель отражает объем памяти, используемой Elasticsearch. Он может быть полезен для оценки нагрузки на оперативную память и необходимости ее увеличения или оптимизации.

Translog Operations (MB): Объем операций в журнале транзакций. Этот показатель отражает объем данных, записанных в журнал транзакций. Он может быть полезен для оценки нагрузки на журнал транзакций и необходимости его оптимизации.

**Метрики производительности:**

Heap memory usage (MB): Elasticsearch использует JVM (Java Virtual Machine), и память Heap — это область, выделенная JVM для выполнения операций, таких как индексация, кэширование и запросы.

File System: показывает состояние файловой системы узла Elasticsearch, включая использование дискового пространства, чтение и запись на диск.

Transport Connections opened: показывает количество открытых транспортных соединений. Транспортный уровень в Elasticsearch используется для связи между узлами в кластере.

Transport Packets: показывает объем переданных данных (пакетов) по транспортному уровню. Помогает отслеживать объем переданных данных по сети между узлами кластера.

Queries: количество запросов, которые обрабатываются или были обработаны узлом Elasticsearch

Refreshes time: время, затраченное на обновление индекса (refresh) — это процесс, когда новые документы становятся доступными для поиска.

**Threadpool:**
Elasticsearch использует пулы потоков для управления выполнением различных задач (например, запросы, индексирование и репликация). Ниже — описание метрик, связанных с пулом потоков:

Fetch shard started: количество задач, которые начали процесс fetch shard (процесс получения данных шардов). Эта операция важна для репликации и восстановления данных.

Fetch shard store: количество задач в пуле потоков для получения данных шардов из хранилища.

Flush: количество операций flush, выполняемых узлом. Flush — это процесс записи данных с диска на постоянное хранилище, который помогает поддерживать консистентность данных.

Snapshot: количество активных задач, связанных с созданием snapshot (снимка) индекса.

Force merge: принудительное объединение сегментов индекса для уменьшения их числа. Это помогает оптимизировать хранение и производительность поиска.
