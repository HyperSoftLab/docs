# Мониторинг производительности приложений (APM)
Концепция построения мониторинга производительности приложений в GMonit предполагает, что система поддерживает различные источники для сбора метрик, трейсов и логов. На данный момент, реализована поддержка протокола NewRelic, что позволяет использовать всю экосистему NewRelic для сбора данных о производительности приложений, разработанных на JVM, .NET (Framework/Core), Python, Ruby, Go, Node.js, Php, C/C++, Elixir. В частности, специфичные для каждой платформы APM-агенты, распространяемые по открытой лицензии Apache 2.0.

!> Все агенты мониторинга взаимодействуют с бэкендом GMonit по защищенному протоколу HTTPS. Это стандартное поведение системы, его нельзя измениить.

!> В большинстве агентов NewRelic "зашиты" корневые сертификаты "из коробки". И по умолчанию, например, там нет поддержки Let's encript. Поэтому, если используются самоподписанные сертификаты или сертификаты Let's encrypt, нужно явно указать агенту на это.

## Установка APM-агента для PHP (NewRelic)
Агент мониторинга PHP от NewRelic состоит из двух взаимодействующих частей:
* расширение для PHP, которое занимается сбором метрик и трейсов;
* прокси-демон, который отвечает за взаимодействие с бэкендом мониторинга, в данном случае с GMonit.

Для установки и настройки агента, необходимо выполнить следующий набор шагов:

1. Установить APM-агент NewRelic для PHP по официальной [инструкции](https://docs.newrelic.com/docs/apm/agents/php-agent/installation/php-agent-installation-overview).

> Если вы используете вместо `glibc` библиотеку `musl libc`, например в `Alpine Linux`, необходимо скачать и установить актуальную версию агента с Musl по [ссылке](https://download.newrelic.com/php_agent/release/).

2. Изменить настройки в конфигурационном файле `newrelic.ini`
```ini
newrelic.license = 0123456789-123456789-123456789-123456789
newrelic.daemon.collector_host = gmonit-collector.<<DOMAIN>>.ru // домен коллектора
```

3. Если используются самоподписанные сертификаты или Let's encript, нужно явно указать это в настройках проксти-демона (`newrelic-daemon`):
    * если он запущен в докере, то добавить ключ к команде запуска  `--cafile /etc/ssl/certs/ca-certificates.crt`;
    * или в newrelic.cfg указать путь к сертификату в параметре `ssl_ca_bundle`.

> Подробнее об этом можно узнать по [ссылке](https://docs.newrelic.com/docs/apm/agents/php-agent/configuration/proxy-daemon-newreliccfg-settings/#proxy-settings)

## Установка APM-агента для Java (NewRelic)
Для установки и настройки агента, необходимо выполнить следующий набор шагов:

1. Установить APM-агент NewRelic для Java по официальной [инструкции](https://docs.newrelic.com/install/java/).

2. Изменить настройки агента в конфигурационном файле `newrelic.yml` или через переменные окружения: 
```yaml
NEW_RELIC_LOG: stdout
NEW_RELIC_LICENSE_KEY: 0123456789-123456789-123456789-123456789
NEW_RELIC_HOST: gmonit-collector.<<DOMAIN>>.ru # домен коллектора
NEW_RELIC_APP_NAME: "MY_AWESOME_APP" # название приложения, которое будете мониторить
```

3. Если используются самоподписанные сертификаты, то нужно явно указать это в настройках агента (`ca_bundle_path`) или в переменных окружения (`NEW_RELIC_CA_BUNDLE_PATH`). Например:
```yaml
NEW_RELIC_CA_BUNDLE_PATH: /gmonit/ssl/rootCA.crt #  путь до бандла сертификатов
```

> Подробнее о конфигурации агента можно узнать по [ссылке](https://docs.newrelic.com/docs/apm/agents/java-agent/configuration/java-agent-configuration-config-file/).

